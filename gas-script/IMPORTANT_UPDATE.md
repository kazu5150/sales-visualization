# 重要な更新: 重複送信防止機能の追加

## 問題

以前のバージョンでは、スプレッドシートでセルを編集するたびに`onEdit`トリガーが発火し、同じデータが複数回Supabaseに送信される問題がありました。

例えば、1行のデータを入力する際に：
1. 日付を入力 → 送信（不完全なデータ）
2. 顧客名を入力 → 送信（不完全なデータ）
3. 商品名を入力 → 送信（不完全なデータ）
...

このように、同じ行が何度も送信されてしまっていました。

---

## 解決策

**送信済みフラグ**機能を追加しました。

### 変更点

1. **J列に「送信済み」フラグを追加**
   - Supabaseへの送信が成功すると、J列に `✓` マークが自動的に設定されます
   - `✓` マークがある行は再送信されません

2. **必須項目の完全性チェック**
   - A列〜G列（日付、顧客名、商品名、数量、単価、合計金額、営業担当者）がすべて入力されるまで送信されません
   - 途中で編集しても、すべての必須項目が揃うまでSupabaseには送信されません

3. **新しいメニュー機能**
   - 「送信済みフラグをクリア」機能を追加
   - データを再送信したい場合に、すべての✓マークを一括削除できます

---

## 新しい動作フロー

### 通常のデータ入力

```
1. 新しい行に日付を入力
   → まだ送信されない（必須項目が不足）

2. 顧客名を入力
   → まだ送信されない（必須項目が不足）

3. 商品名を入力
   → まだ送信されない（必須項目が不足）

4. 数量を入力
   → まだ送信されない（必須項目が不足）

5. 単価を入力
   → まだ送信されない（必須項目が不足）

6. 合計金額を入力
   → まだ送信されない（必須項目が不足）

7. 営業担当者を入力
   → すべての必須項目が揃ったので、Supabaseに送信！
   → J列に ✓ マークが自動的に設定される

8. カテゴリや備考を後から追加
   → 既に送信済み（✓マーク付き）なので再送信されない
```

### データの修正

```
1. 送信済みの行（✓マーク付き）を編集
   → 再送信されない（重複を防ぐ）

2. データを修正して再送信したい場合
   → 手動でJ列の✓マークを削除
   → 編集すると再送信される
   → または「送信済みフラグをクリア」メニューを使用
```

---

## 使い方

### スプレッドシートのヘッダー行を更新

1行目に以下のヘッダーを設定してください：

| A | B | C | D | E | F | G | H | I | J |
|---|---|---|---|---|---|---|---|---|---|
| 日付 | 顧客名 | 商品名 | 数量 | 単価 | 合計金額 | 営業担当者 | カテゴリ | 備考 | **送信済み** |

### Apps Scriptを更新

1. スプレッドシートで「拡張機能」→「Apps Script」を開く
2. 既存のコードを**すべて削除**
3. 新しい`Code.gs`の内容をコピー＆ペースト
4. 保存

### 既存データの処理

既存のスプレッドシートに既にデータがある場合：

**オプション1: 重複を避けたい場合**
1. 「Supabase同期」メニュー → 「送信済みフラグをクリア」
2. J列に手動で `✓` を入力（既に送信済みの行に）
3. 新しいデータのみが送信されます

**オプション2: データを再送信してもOKな場合**
1. Supabaseのデータを一度削除
2. 「Supabase同期」メニュー → 「全データを同期」
3. すべてのデータが送信され、✓マークが設定されます

---

## トラブルシューティング

### Q: データが送信されない

**A:** 以下を確認してください：
1. A列〜G列（必須項目）がすべて入力されているか
2. J列に✓マークがついていないか（既に送信済み）
3. GASスクリプトが最新版に更新されているか

### Q: データを修正して再送信したい

**A:** 2つの方法があります：
1. **特定の行のみ**: J列の✓マークを手動で削除 → セルを編集
2. **すべての行**: 「Supabase同期」メニュー → 「送信済みフラグをクリア」

### Q: 既存の重複データを削除したい

**A:** Supabaseダッシュボードで直接削除してください：
1. https://supabase.com にアクセス
2. プロジェクトを開く
3. 「Table Editor」→「sales_records」
4. 重複データを手動で削除

---

## まとめ

この更新により：
- ✅ データの重複送信が防止されます
- ✅ 入力途中での不完全なデータ送信を防ぎます
- ✅ どのデータが送信済みかが視覚的にわかります
- ✅ 必要に応じてデータを再送信できます

より安定したデータ同期が可能になりました！
