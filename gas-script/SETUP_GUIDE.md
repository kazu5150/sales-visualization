# Googleスプレッドシート連携 セットアップガイド

## 概要

このガイドでは、Googleスプレッドシートに入力した営業データを自動的にSupabaseに同期し、Next.jsダッシュボードでリアルタイム表示する設定方法を説明します。

---

## セットアップ手順

### ステップ1: Googleスプレッドシートの作成

1. [Google Sheets](https://sheets.google.com)にアクセス
2. **新しいスプレッドシート**を作成
3. シート名を `営業データ` に変更（重要）
4. 1行目に以下のヘッダーを入力：

   | A | B | C | D | E | F | G | H | I |
   |---|---|---|---|---|---|---|---|---|
   | 日付 | 顧客名 | 商品名 | 数量 | 単価 | 合計金額 | 営業担当者 | カテゴリ | 備考 |

---

### ステップ2: Google Apps Script (GAS) のセットアップ

1. スプレッドシートで **「拡張機能」** → **「Apps Script」** を選択

2. 開いたスクリプトエディタに、`gas-script/Code.gs` の内容を**すべてコピー＆ペースト**

3. スクリプトの上部にある設定値を確認：
   ```javascript
   const SUPABASE_URL = 'https://srxbdcfcykgqmnlcqdcr.supabase.co';
   const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUz...';  // 既に設定済み
   ```
   ※ これらの値は既に正しく設定されています

4. **「プロジェクトを保存」**（Ctrl + S または Cmd + S）

---

### ステップ3: 接続テスト

1. スクリプトエディタで **`testConnection`** 関数を選択
2. **「実行」**ボタンをクリック
3. 初回実行時、権限の承認が求められます：
   - **「権限を確認」** をクリック
   - Googleアカウントを選択
   - **「詳細」** → **「（プロジェクト名）に移動」** をクリック
   - **「許可」** をクリック
4. 「Supabaseに正常に接続できました！」のメッセージが表示されればOK

---

### ステップ4: 自動同期トリガーの設定

1. スクリプトエディタ左側の **「トリガー」**（時計アイコン）をクリック
2. 右下の **「トリガーを追加」** をクリック
3. 以下の設定を行います：

   | 項目 | 設定値 |
   |-----|--------|
   | 実行する関数を選択 | `onEdit` |
   | 実行するデプロイを選択 | Head |
   | イベントのソースを選択 | スプレッドシートから |
   | イベントの種類を選択 | 編集時 |

4. **「保存」** をクリック

これで、スプレッドシートを編集するたびに自動的にSupabaseへ同期されます！

---

### ステップ5: カスタムメニューの有効化

1. スプレッドシートを**リロード**（F5またはCmd + R）
2. 上部メニューバーに **「Supabase同期」** という新しいメニューが表示されます
3. このメニューから以下の機能を利用できます：
   - **「全データを同期」**: 既存の全データをSupabaseに一括送信
   - **「設定をテスト」**: Supabase接続のテスト

---

## 使い方

### データの入力

1. スプレッドシートの2行目以降にデータを入力
2. **入力した瞬間に自動的にSupabaseへ同期**されます
3. Next.jsダッシュボード（http://localhost:3002）が**リアルタイムで更新**されます

### サンプルデータ

以下のようなデータを入力してみてください：

```
日付        | 顧客名              | 商品名          | 数量 | 単価   | 合計金額 | 営業担当者 | カテゴリ | 備考
2025-10-26 | 株式会社テスト      | テスト商品A     | 1    | 10000  | 10000    | 山田太郎   | テスト   | テストデータ
```

---

## トラブルシューティング

### データが同期されない場合

1. **スクリプトのログを確認**
   - Apps Scriptエディタで「実行」→「実行ログを表示」
   - エラーメッセージがあればコピーして確認

2. **手動で同期を試す**
   - 「Supabase同期」メニュー → 「全データを同期」
   - エラーメッセージを確認

3. **接続テストを実行**
   - 「Supabase同期」メニュー → 「設定をテスト」
   - 接続に失敗する場合、SUPABASE_URLとSUPABASE_ANON_KEYを確認

### よくあるエラー

**「シート "営業データ" が見つかりません」**
- → シート名が正しいか確認してください（全角スペース含む）

**「権限が不足しています」**
- → トリガーの再設定を試してください

**「接続に失敗しました」**
- → Supabaseプロジェクトがアクティブか確認してください

---

## 制限事項

- Googleスプレッドシートのトリガーには**実行回数制限**があります
- 大量のデータを一度に編集する場合は、「全データを同期」メニューを使用してください
- 1行編集するたびに1回APIリクエストが発生します

---

## まとめ

これで以下のワークフローが完成しました：

```
Googleスプレッドシート（データ入力）
    ↓ [GASトリガー自動実行]
Supabase（データ保存）
    ↓ [リアルタイムサブスクリプション]
Next.jsダッシュボード（可視化）
```

営業データを入力すると、**リアルタイムでダッシュボードに反映**されます！
